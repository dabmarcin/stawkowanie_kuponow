#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Aplikacja Streamlit do zarzƒÖdzania stawkowaniem kupon√≥w zak≈Çad√≥w.

Interfejs webowy dla systemu automatycznego wyliczania rekomendowanych stawek
wed≈Çug strategii Martingale z celem odzyskania wk≈Çadu + 100 z≈Ç zysku.
"""

import streamlit as st
import pandas as pd
import numpy as np
from datetime import datetime
import os
import math

# Import naszych modu≈Ç√≥w
from business_logic import (
    recompute_aggregates, get_current_status, recommend_stake,
    calculate_potential_result, get_next_coupon_number, format_currency,
    get_game_status, validate_odds, validate_stake, parse_float,
    validate_withdrawal, create_deposit_coupon, create_withdrawal_coupon,
    get_transaction_history, PROFIT_TARGET, delete_coupon, delete_coupons,
    edit_coupon, save_profit_target, load_profit_target, validate_budget_for_stake
)
from csv_handler import (
    load_rows, save_rows, migrate_old_format, create_empty_csv,
    backup_csv, validate_csv_structure, get_csv_info, CSV_FILE,
    create_empty_template_csv, load_csv_from_string, save_csv_to_string,
    validate_csv_content
)

# ============================================================================
# FUNKCJE TRYBU SESJI
# ============================================================================

def get_session_data():
    """Pobiera dane z session_state lub zwraca pustƒÖ listƒô."""
    if 'coupons_data' not in st.session_state:
        st.session_state.coupons_data = []
    return st.session_state.coupons_data

def save_session_data(rows):
    """Zapisuje dane do session_state."""
    st.session_state.coupons_data = rows

def clear_session_data():
    """Czy≈õci dane z session_state."""
    if 'coupons_data' in st.session_state:
        del st.session_state.coupons_data

def load_csv_from_upload(uploaded_file):
    """Wczytuje dane CSV z przes≈Çanego pliku."""
    try:
        # Konwertuj bytes na string
        csv_content = uploaded_file.read().decode('utf-8')
        
        # Waliduj zawarto≈õƒá
        is_valid, error_message = validate_csv_content(csv_content)
        if not is_valid:
            st.error(f"‚ùå B≈ÇƒÖd w pliku CSV: {error_message}")
            return []
        
        # Wczytaj dane
        rows = load_csv_from_string(csv_content)
        return rows
    except Exception as e:
        st.error(f"‚ùå B≈ÇƒÖd podczas wczytywania pliku: {e}")
        return []

def get_csv_download_data(rows):
    """Przygotowuje dane CSV do pobrania."""
    return save_csv_to_string(rows)

# Funkcje pomocnicze
def is_pending(row) -> bool:
    """Sprawdza czy kupon oczekuje na rozliczenie"""
    val = str(row.get("Wynik", "")).strip().upper()
    return val in {"OCZEKUJE", ""}  # obs≈Çuguje stare rekordy z pustym Wynik

def color_result(val):
    """Koloruje wyniki kupon√≥w w tabeli"""
    v = str(val).strip().upper()
    if v in ("WYGRANA", "W"):
        return 'background-color: #d4edda; color: #155724;'
    elif v in ("PRZEGRANA", "P"):
        return 'background-color: #f8d7da; color: #721c24;'
    else:
        return 'background-color: #fff3cd; color: #856404;'


# ============================================================================
# KONFIGURACJA STRAMLIT
# ============================================================================

st.set_page_config(
    page_title="üé∞ Stawkowanie Kupon√≥w",
    page_icon="üé∞",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ============================================================================
# FUNKCJE WY≈öWIETLANIA
# ============================================================================

def display_status_cards(status: dict):
    """Wy≈õwietla karty ze statusem gry."""
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        st.metric(
            "üí∞ Wk≈Çad",
            f"{format_currency(status['sum_deposits'])}",
            delta=f"Saldo: {format_currency(status['balance'])}"
        )
    
    with col2:
        # Koloruj bud≈ºet w zale≈ºno≈õci od warto≈õci
        budget_value = status['budget']
        if budget_value <= 0:
            st.metric(
                "üéØ Bud≈ºet",
                f"0.00 z≈Ç",
                delta="‚ö†Ô∏è WYKORZYSTANY - Zasil konto!"
            )
        else:
            st.metric(
                "üéØ Bud≈ºet",
                f"{format_currency(budget_value)}",
                delta=f"Cel: {format_currency(status['target'])}"
            )
    
    with col3:
        delta = status['target'] - status['budget']
        st.metric(
            "üéØ Cel",
            f"{format_currency(status['target'])}",
            delta=f"Do celu: {format_currency(delta)}"
        )
    
    with col4:
        st.metric(
            "üìä Zysk netto",
            f"{format_currency(status['net_profit'])}",
            delta=f"Cel: {format_currency(st.session_state.profit_target)}"
        )


def display_coupons_table(rows: list):
    """
    Wy≈õwietla tabelƒô kupon√≥w.
    """
    if not rows:
        st.info("üìã Brak kupon√≥w w bazie danych.")
        return
    
    # Konwertuj na DataFrame dla lepszego wy≈õwietlania
    df = pd.DataFrame(rows)
    
    # Dodaj kolumny z kolorami dla lepszej czytelno≈õci
    styled_df = df.style.map(color_result, subset=['Wynik'])
    
    st.dataframe(
        styled_df,
        use_container_width=True,
        height=400
    )


def display_game_status(status: dict):
    """
    Wy≈õwietla status gry.
    """
    game_status = get_game_status(status['balance'], status['sum_deposits'])
    
    if status['balance'] < 0:
        st.warning(f"‚ö†Ô∏è {game_status}")
    elif status['balance'] > 0:
        st.success(f"‚úÖ {game_status}")
    else:
        st.info(f"‚ÑπÔ∏è {game_status}")


# ============================================================================
# G≈Å√ìWNA FUNKCJA
# ============================================================================

def main():
    """G≈Ç√≥wna funkcja aplikacji."""
    
    # Inicjalizuj profit_target w session_state z pliku
    if 'profit_target' not in st.session_state:
        st.session_state.profit_target = load_profit_target()
    
    # Nag≈Ç√≥wek aplikacji
    st.title("üé∞ Aplikacja do Stawkowania Kupon√≥w")
    st.caption(f"üéØ Docelowy zysk: {st.session_state.profit_target} z≈Ç")
    
    # Pobierz dane z session_state
    rows = get_session_data()
    
    # Interfejs do pobierania i wczytywania plik√≥w CSV
    if not rows:
        st.header("üìÅ ZarzƒÖdzanie danymi")
        
        col1, col2 = st.columns(2)
        
        with col1:
            st.subheader("üì• Wczytaj dane")
            uploaded_file = st.file_uploader(
                "Wybierz plik CSV z danymi kupon√≥w",
                type=['csv'],
                help="Wczytaj sw√≥j plik CSV z danymi kupon√≥w"
            )
            
            if uploaded_file is not None:
                if st.button("üìÇ Wczytaj plik", type="primary"):
                    rows = load_csv_from_upload(uploaded_file)
                    if rows:
                        # Przelicz agregaty po wczytaniu danych
                        recompute_aggregates(rows)
                        save_session_data(rows)
                        st.success(f"‚úÖ Wczytano {len(rows)} kupon√≥w z pliku")
                        st.rerun()
        
        with col2:
            st.subheader("üì§ Pobierz szablon")
            st.info("Je≈õli nie masz jeszcze pliku z danymi, pobierz pusty szablon CSV")
            
            # Przygotuj pusty szablon do pobrania
            empty_csv = create_empty_template_csv()
            
            st.download_button(
                label="üì• Pobierz pusty szablon CSV",
                data=empty_csv,
                file_name="szablon_kuponow.csv",
                mime="text/csv",
                help="Pobierz pusty szablon CSV, wype≈Çnij go danymi i wczytaj z powrotem"
            )
        
        st.markdown("---")
    
    # Je≈õli brak danych, poka≈º formularz pierwszego kuponu
    if not rows:
        st.header("üé≤ Utw√≥rz pierwszy kupon")
        st.info("Witaj! Aby rozpoczƒÖƒá, utw√≥rz pierwszy kupon.")
        
        with st.form("first_coupon_form"):
            col1, col2 = st.columns(2)
            
            with col1:
                deposit = st.number_input(
                    "PoczƒÖtkowy wk≈Çad",
                    min_value=0.01,
                    step=0.01,
                    value=100.0,
                    format="%.2f"
                )
            
            with col2:
                st.subheader("üé≤ Szczeg√≥≈Çy pierwszego kuponu")
            
            # Pole nazwy
            coupon_name = st.text_input(
                "Nazwa kuponu",
                placeholder="np. Mecz Real vs Barcelona",
                help="Wpisz opisowƒÖ nazwƒô dla tego kuponu"
            )
            
            col1, col2 = st.columns(2)
            
            with col1:
                odds = st.number_input(
                    "Kurs",
                    min_value=1.01,
                    step=0.01,
                    value=2.5,
                    format="%.2f"
                )
            
            with col2:
                stake = st.number_input(
                    "Stawka",
                    min_value=0.01,
                    step=0.01,
                    value=10.0,
                    format="%.2f"
                )
            
            submitted = st.form_submit_button("‚úÖ Utw√≥rz pierwszy kupon", type="primary")
            
            if submitted:
                if not validate_odds(odds):
                    st.error("‚ùå Kurs musi byƒá wiƒôkszy ni≈º 1.0!")
                elif not validate_stake(stake):
                    st.error("‚ùå Stawka musi byƒá wiƒôksza ni≈º 0!")
                else:
                    # Utw√≥rz pierwszy kupon
                    first_coupon = {
                        "Kupon": "1",
                        "Nazwa": coupon_name if coupon_name.strip() else "Kupon #1",
                        "Wynik": "OCZEKUJE",
                        "Stawka (S)": f"{stake:.2f}",
                        "Kurs": f"{odds:.2f}",
                        "Zasilenie": f"{deposit:.2f}",
                        "Suma zasiele≈Ñ": "0.00",
                        "Suma w≈Ço≈ºona do tej pory": "0.00",
                        "Wygrana brutto": "0.00",
                        "Saldo": "0.00",
                        "Zysk netto": "0.00"
                    }
                    
                    rows = [first_coupon]
                    recompute_aggregates(rows)
                    save_session_data(rows)
                    st.success("‚úÖ Pierwszy kupon utworzony!")
                    st.rerun()
        
        return
    
    # Oblicz aktualny status
    status = get_current_status(rows, st.session_state.profit_target)
    
    if not status:
        st.error("‚ùå B≈ÇƒÖd podczas obliczania statusu gry.")
        return
    
    # Wy≈õwietl status gry
    st.header("üìä Bie≈ºƒÖcy stan gry")
    display_status_cards(status)
    display_game_status(status)
    
    # Dodatkowe ostrze≈ºenie gdy bud≈ºet jest 0
    if status['budget'] <= 0:
        st.error("üö® **UWAGA!** Wykorzysta≈Çe≈õ ca≈Çy dostƒôpny bud≈ºet! Nie mo≈ºesz graƒá dalej bez zasilenia konta.")
        st.info("üí° **Co robiƒá:** Zasil konto w sekcji 'ZarzƒÖdzanie ≈õrodkami' w sidebar, aby kontynuowaƒá grƒô.")
    
    # A) KUPONY OCZEKUJƒÑCE - lista wszystkich oczekujƒÖcych z przyciskami rozliczania
    pending_coupons = [row for row in rows if is_pending(row)]
    
    if pending_coupons:
        st.header("‚è≥ Kupony oczekujƒÖce na rozliczenie")
        
        for coupon in pending_coupons:
            coupon_name = coupon.get('Nazwa', f"Kupon #{coupon['Kupon']}")
            with st.expander(
                f"{coupon_name} ‚Äì kurs {coupon['Kurs']} ‚Äì stawka {coupon['Stawka (S)']} z≈Ç",
                expanded=False
            ):
                col1, col2, col3 = st.columns(3)
                
                with col1:
                    st.write(f"**Kurs:** {coupon['Kurs']}")
                    st.write(f"**Stawka:** {coupon['Stawka (S)']} z≈Ç")
                
                with col2:
                    potential_win = float(coupon['Kurs']) * float(coupon['Stawka (S)'])
                    st.write(f"**Potencjalna wygrana brutto:** {potential_win:.2f} z≈Ç")
                
                with col3:
                    if st.button("‚úÖ Wygrana", key=f"win_{coupon['Kupon']}"):
                        coupon['Wynik'] = 'WYGRANA'   # pe≈Çne s≈Çowo
                        recompute_aggregates(rows)
                        save_session_data(rows)
                        st.success("‚úÖ Kupon rozliczony jako WYGRANA")
                        st.rerun()
                    
                    if st.button("‚ùå Przegrana", key=f"lose_{coupon['Kupon']}"):
                        coupon['Wynik'] = 'PRZEGRANA' # pe≈Çne s≈Çowo
                        coupon['Wygrana brutto'] = "0.00"
                        recompute_aggregates(rows)
                        save_session_data(rows)
                        st.success("‚ùå Kupon rozliczony jako PRZEGRANA")
                        st.rerun()
                    
                    if st.button("üóëÔ∏è Usu≈Ñ", key=f"delete_{coupon['Kupon']}", type="secondary"):
                        if delete_coupon(rows, coupon['Kupon']):
                            recompute_aggregates(rows)
                            save_session_data(rows)
                            st.success(f"‚úÖ Usuniƒôto kupon #{coupon['Kupon']}")
                            st.rerun()
                        else:
                            st.error(f"‚ùå Nie uda≈Ço siƒô usunƒÖƒá kuponu #{coupon['Kupon']}")
        
        st.markdown("---")
    
    # B) DODAWANIE NOWEGO KUPONU - przycisk zawsze dostƒôpny
    if st.button("üé≤ Nowy kupon", type="primary", use_container_width=True):
        st.session_state.show_new_coupon = True
        st.rerun()
    
    # Uniwersalny formularz dodawania kuponu
    if st.session_state.get('show_new_coupon', False):
        st.header("üé≤ Dodaj nowy kupon")
        
        # Pola POZA formularzem - automatyczne od≈õwie≈ºanie
        col1, col2 = st.columns(2)
        
        with col1:
            odds = st.number_input(
                "Kurs",
                min_value=1.01,
                step=0.01,
                value=2.5,
                format="%.2f",
                key="odds_universal"
            )
        
        with col2:
            # Pole w≈Çasnej stawki
            custom_stake = st.number_input(
                "W≈Çasna stawka",
                min_value=0.01,
                step=0.01,
                value=10.0,
                format="%.2f",
                key="custom_stake_universal"
            )
        
        # Oblicz rekomendowanƒÖ stawkƒô je≈õli jeste≈õmy na minusie
        recommended_stake = None
        if status['net_profit'] < st.session_state.profit_target:
            try:
                recommended_stake = recommend_stake(status['budget'], status['target'], odds, st.session_state.profit_target)
            except:
                recommended_stake = None
        
        # Poka≈º rekomendacjƒô je≈õli jeste≈õmy na minusie
        if recommended_stake is not None:
            st.info(f"üí∞ Rekomendowana stawka: {recommended_stake:.2f} z≈Ç")
        else:
            st.info("‚úÖ Jeste≈õ na plusie - mo≈ºesz graƒá w≈ÇasnƒÖ stawkƒÖ")
        
        # Poka≈º potencjalny wynik i sprawd≈∫ bud≈ºet
        if custom_stake > 0 and odds > 1:
            potential_win = odds * custom_stake
            potential_profit = custom_stake * (odds - 1)
            new_budget = status['budget'] - custom_stake + potential_win
            
            # Sprawd≈∫ czy stawka jest w bud≈ºecie
            budget_valid, budget_message = validate_budget_for_stake(rows, custom_stake)
            
            if budget_valid:
                st.metric(
                    "üí° Potencjalny wynik",
                    f"{potential_win:.2f} z≈Ç",
                    delta=f"Zysk: {format_currency(potential_profit)}"
                )
                st.caption(f"Nowy bud≈ºet po wygranej: {new_budget:.2f} z≈Ç")
                st.success(budget_message)
            else:
                st.metric(
                    "üí° Potencjalny wynik",
                    f"{potential_win:.2f} z≈Ç",
                    delta=f"Zysk: {format_currency(potential_profit)}"
                )
                st.caption(f"Nowy bud≈ºet po wygranej: {new_budget:.2f} z≈Ç")
                st.error(budget_message)
                st.warning("‚ö†Ô∏è Nie mo≈ºesz graƒá tƒÖ stawkƒÖ - przekracza dostƒôpny bud≈ºet!")
        
        # Formularz z przyciskami
        with st.form("add_coupon_universal"):
            # Pole nazwy
            coupon_name = st.text_input(
                "Nazwa kuponu",
                placeholder="np. Mecz Real vs Barcelona",
                help="Wpisz opisowƒÖ nazwƒô dla tego kuponu",
                key="name_universal"
            )
            
            # Opcjonalne zasilenie
            deposit = st.number_input(
                "Zasilenie (opcjonalnie)",
                min_value=0.0,
                step=0.01,
                value=0.0,
                format="%.2f",
                key="deposit_universal"
            )
            
            # Przyciski w zale≈ºno≈õci od statusu
            if recommended_stake is not None:
                col_btn1, col_btn2 = st.columns(2)
                
                with col_btn1:
                    use_recommended = st.form_submit_button(
                        f"‚úÖ U≈ºyj rekomendowanej stawki ({recommended_stake:.2f} z≈Ç)",
                        type="primary"
                    )
                
                with col_btn2:
                    use_custom = st.form_submit_button(
                        f"üéØ U≈ºyj w≈Çasnej stawki ({custom_stake:.2f} z≈Ç)",
                        type="secondary"
                    )
                
                # Wybierz stawkƒô na podstawie klikniƒôtego przycisku
                if use_recommended:
                    stake = recommended_stake
                    submitted = True
                elif use_custom:
                    stake = custom_stake
                    submitted = True
                else:
                    stake = custom_stake  # domy≈õlnie w≈Çasna stawka
                    submitted = False
            else:
                # Jeste≈õmy na plusie - tylko w≈Çasna stawka
                stake = custom_stake
                submitted = st.form_submit_button("‚úÖ Dodaj kupon", type="primary")
            
            # Logika dodawania kuponu
            if submitted:
                if not validate_odds(odds):
                    st.error("‚ùå Kurs musi byƒá wiƒôkszy ni≈º 1.0!")
                elif not validate_stake(stake):
                    st.error("‚ùå Stawka musi byƒá wiƒôksza ni≈º 0!")
                else:
                    # Sprawd≈∫ czy stawka nie przekracza bud≈ºetu
                    budget_valid, budget_message = validate_budget_for_stake(rows, stake)
                    
                    if not budget_valid:
                        st.error(budget_message)
                        # Poka≈º opcjƒô zasilenia
                        if deposit > 0:
                            st.info("üí° Mo≈ºesz zasiliƒá konto w polu 'Zasilenie' poni≈ºej")
                        else:
                            st.info("üí° Zwiƒôksz bud≈ºet poprzez zasilenie konta w sekcji 'ZarzƒÖdzanie ≈õrodkami'")
                    else:
                        # Walidacja przesz≈Ça - dodaj kupon
                        next_number = get_next_coupon_number(rows)
                        
                        new_coupon = {
                            "Kupon": str(next_number),
                            "Nazwa": coupon_name if coupon_name.strip() else f"Kupon #{next_number}",
                            "Wynik": "OCZEKUJE",
                            "Stawka (S)": f"{stake:.2f}",
                            "Kurs": f"{odds:.2f}",
                            "Zasilenie": f"{deposit:.2f}",
                            "Suma zasiele≈Ñ": "0.00",
                            "Suma w≈Ço≈ºona do tej pory": "0.00",
                            "Wygrana brutto": "0.00",
                            "Saldo": "0.00",
                            "Zysk netto": "0.00"
                        }
                        
                        rows.append(new_coupon)
                        recompute_aggregates(rows)
                        save_session_data(rows)
                        
                        st.success(f"‚úÖ Dodano kupon #{next_number}")
                        st.success(budget_message)  # Poka≈º potwierdzenie bud≈ºetu
                        st.session_state.show_new_coupon = False
                        st.rerun()
    
    # Wy≈õwietl tabelƒô kupon√≥w
    st.header("üìã Historia kupon√≥w")
    display_coupons_table(rows)
    
    # Dodatkowe opcje w sidebar
    with st.sidebar:
        st.markdown("---")
        st.subheader("üí∞ ZarzƒÖdzanie ≈õrodkami")
        
        # Wp≈Çata
        with st.expander("üíµ Wp≈Çata", expanded=False):
            with st.form("deposit_form"):
                deposit_amount = st.number_input(
                    "Kwota wp≈Çaty",
                    min_value=0.01,
                    step=0.01,
                    value=100.0,
                    format="%.2f"
                )
                
                if st.form_submit_button("üí∞ Wp≈Çaƒá", type="primary"):
                    next_number = get_next_coupon_number(rows)
                    deposit_coupon = create_deposit_coupon(deposit_amount, next_number)
                    
                    rows.append(deposit_coupon)
                    recompute_aggregates(rows)
                    save_session_data(rows)
                    st.success(f"‚úÖ Wp≈Çacono {deposit_amount:.2f} z≈Ç")
                    st.rerun()
        
        # Wyp≈Çata
        with st.expander("üí∏ Wyp≈Çata", expanded=False):
            with st.form("withdrawal_form"):
                withdrawal_amount = st.number_input(
                    "Kwota wyp≈Çaty",
                    min_value=0.01,
                    step=0.01,
                    value=100.0,
                    format="%.2f"
                )
                
                if st.form_submit_button("üí∏ Wyp≈Çaƒá", type="primary"):
                    # Pobierz aktualny bud≈ºet
                    status = get_current_status(rows, st.session_state.profit_target)
                    if not status:
                        st.error("‚ùå B≈ÇƒÖd podczas obliczania statusu bud≈ºetu")
                    else:
                        # Waliduj wyp≈Çatƒô
                        validation_result = validate_withdrawal(status['budget'], withdrawal_amount)
                        if validation_result['valid']:
                            next_number = get_next_coupon_number(rows)
                            withdrawal_coupon = create_withdrawal_coupon(withdrawal_amount, next_number)
                            
                            rows.append(withdrawal_coupon)
                            recompute_aggregates(rows)
                            save_session_data(rows)
                            st.success(f"‚úÖ Wyp≈Çacono {withdrawal_amount:.2f} z≈Ç")
                            st.rerun()
                        else:
                            st.error(f"‚ùå {validation_result['error']}")
        
        # Zmiana celu
        with st.expander("üéØ Zmiana celu", expanded=False):
            with st.form("target_form"):
                new_target = st.number_input(
                    "Nowy cel zysku",
                    min_value=1.0,
                    step=1.0,
                    value=st.session_state.profit_target,
                    format="%.0f"
                )
                
                if st.form_submit_button("üéØ Zmie≈Ñ cel", type="primary"):
                    st.session_state.profit_target = new_target
                    if save_profit_target(new_target):
                        st.success(f"‚úÖ Cel zmieniony na {new_target:.0f} z≈Ç i zapisany")
                    else:
                        st.error("‚ùå B≈ÇƒÖd podczas zapisywania celu")
                    st.rerun()
        
        # Historia transakcji
        with st.expander("üìä Historia transakcji", expanded=False):
            transactions = get_transaction_history(rows)
            if transactions:
                for transaction in transactions[-5:]:  # Ostatnie 5 transakcji
                    if transaction['type'] == 'deposit':
                        st.success(f"üí∞ {transaction['description']} (Kupon #{transaction['coupon']})")
                    else:
                        st.warning(f"üí∏ {transaction['description']} (Kupon #{transaction['coupon']})")
            else:
                st.info("Brak transakcji")
        
        st.markdown("---")
        st.subheader("üóëÔ∏è ZarzƒÖdzanie kuponami")
        
        # Edytuj kupon
        with st.expander("‚úèÔ∏è Edytuj kupon", expanded=False):
            if rows:
                # Lista kupon√≥w oczekujƒÖcych na rozliczenie
                pending_coupons = [row for row in rows if is_pending(row)]
                
                if pending_coupons:
                    with st.form("edit_coupon_form"):
                        # Wyb√≥r kuponu do edycji
                        selected_coupon = st.selectbox(
                            "Wybierz kupon do edycji:",
                            [row['Kupon'] for row in pending_coupons],
                            format_func=lambda x: next((row['Nazwa'] for row in pending_coupons if row['Kupon'] == x), f"Kupon #{x}"),
                            key="edit_coupon_select"
                        )
                        
                        # Znajd≈∫ wybrany kupon
                        coupon_to_edit = next((row for row in pending_coupons if row['Kupon'] == selected_coupon), None)
                        
                        if coupon_to_edit:
                            col1, col2 = st.columns(2)
                            
                            with col1:
                                new_name = st.text_input(
                                    "Nazwa kuponu",
                                    value=coupon_to_edit.get('Nazwa', ''),
                                    key="edit_name"
                                )
                                new_stake = st.number_input(
                                    "Stawka",
                                    min_value=0.01,
                                    step=0.01,
                                    value=float(coupon_to_edit.get('Stawka (S)', 0)),
                                    format="%.2f",
                                    key="edit_stake"
                                )
                            
                            with col2:
                                new_odds = st.number_input(
                                    "Kurs",
                                    min_value=1.01,
                                    step=0.01,
                                    value=float(coupon_to_edit.get('Kurs', 1.01)),
                                    format="%.2f",
                                    key="edit_odds"
                                )
                            
                            if st.form_submit_button("‚úÖ Zapisz zmiany", type="primary"):
                                if edit_coupon(rows, selected_coupon, new_name, new_stake, new_odds):
                                    recompute_aggregates(rows)
                                    save_session_data(rows)
                                    st.success(f"‚úÖ Kupon #{selected_coupon} zosta≈Ç edytowany")
                                    st.rerun()
                                else:
                                    st.error("‚ùå Nie uda≈Ço siƒô edytowaƒá kuponu")
                else:
                    st.info("Brak kupon√≥w oczekujƒÖcych na rozliczenie")
            else:
                st.info("Brak kupon√≥w w bazie danych")
        
        # Usu≈Ñ ostatni kupon
        if rows:
            last_coupon = rows[-1]
            last_coupon_name = last_coupon.get('Nazwa', f"#{last_coupon['Kupon']}")
            if st.button(f"üóëÔ∏è Usu≈Ñ ostatni kupon ({last_coupon_name})", type="secondary", use_container_width=True):
                if delete_coupon(rows, last_coupon['Kupon']):
                    recompute_aggregates(rows)
                    save_session_data(rows)
                    st.success(f"‚úÖ Usuniƒôto kupon #{last_coupon['Kupon']}")
                    st.rerun()
                else:
                    st.error(f"‚ùå Nie uda≈Ço siƒô usunƒÖƒá kuponu #{last_coupon['Kupon']}")
        
        # Usu≈Ñ wybrane kupony
        with st.expander("üóëÔ∏è Usu≈Ñ wybrane kupony", expanded=False):
            if rows:
                with st.form("delete_multiple_form"):
                    # Lista wszystkich kupon√≥w
                    coupon_numbers = [row["Kupon"] for row in rows]
                    selected_coupons = st.multiselect(
                        "Wybierz kupony do usuniƒôcia:",
                        coupon_numbers,
                        format_func=lambda x: next((row['Nazwa'] for row in rows if row['Kupon'] == x), f"Kupon #{x}"),
                        key="delete_multiple_sidebar"
                    )
                    
                    if selected_coupons:
                        st.warning(f"‚ö†Ô∏è Zaznaczono {len(selected_coupons)} kupon√≥w do usuniƒôcia")
                    
                    # Przycisk submit zawsze dostƒôpny
                    submitted = st.form_submit_button("üóëÔ∏è Usu≈Ñ zaznaczone", type="secondary")
                    
                    if submitted and selected_coupons:
                        deleted_count = delete_coupons(rows, selected_coupons)
                        if deleted_count > 0:
                            recompute_aggregates(rows)
                            save_session_data(rows)
                            st.success(f"‚úÖ Usuniƒôto {deleted_count} kupon√≥w")
                            st.rerun()
                        else:
                            st.error("‚ùå Nie uda≈Ço siƒô usunƒÖƒá ≈ºadnego kuponu")
                    elif submitted and not selected_coupons:
                        st.warning("‚ö†Ô∏è Wybierz kupony do usuniƒôcia")
            else:
                st.info("Brak kupon√≥w w bazie danych")
        
        st.markdown("---")
        st.subheader("üìÅ ZarzƒÖdzanie plikami")
        
        # Przycisk do pobrania aktualnych danych
        if rows:
            csv_data = get_csv_download_data(rows)
            st.download_button(
                label="üì• Pobierz dane CSV",
                data=csv_data,
                file_name=f"kupony_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv",
                mime="text/csv",
                help="Pobierz aktualne dane kupon√≥w jako plik CSV"
            )
        
        # Przycisk do wczytania nowego pliku
        with st.expander("üìÇ Wczytaj nowy plik CSV", expanded=False):
            new_uploaded_file = st.file_uploader(
                "Wybierz nowy plik CSV",
                type=['csv'],
                help="Wczytaj nowy plik CSV (zastƒÖpi obecne dane)",
                key="new_file_uploader"
            )
            
            if new_uploaded_file is not None:
                if st.button("üîÑ ZastƒÖp dane nowym plikiem", type="secondary"):
                    new_rows = load_csv_from_upload(new_uploaded_file)
                    if new_rows:
                        # Przelicz agregaty po wczytaniu danych
                        recompute_aggregates(new_rows)
                        save_session_data(new_rows)
                        st.success(f"‚úÖ ZastƒÖpiono dane - wczytano {len(new_rows)} kupon√≥w")
                        st.rerun()
        
        st.markdown("---")
        st.subheader("üîß Opcje")
        
        if st.button("üíæ Utw√≥rz backup"):
            backup_name = backup_csv()
            if backup_name:
                st.success(f"‚úÖ Backup utworzony: {backup_name}")
        
        if st.button("üóëÔ∏è Wyczy≈õƒá bazƒô danych"):
            st.session_state.show_delete_confirm = True
        
        if st.session_state.get('show_delete_confirm', False):
            st.warning("‚ö†Ô∏è Czy na pewno chcesz wyczy≈õciƒá bazƒô danych? Ta operacja jest nieodwracalna!")
            col1, col2 = st.columns(2)
            
            with col1:
                if st.button("‚úÖ Tak, usu≈Ñ", type="primary"):
                    clear_session_data()
                    st.success("‚úÖ Baza danych wyczyszczona")
                    st.session_state.show_delete_confirm = False
                    st.rerun()
            
            with col2:
                if st.button("‚ùå Anuluj", type="secondary"):
                    st.session_state.show_delete_confirm = False
                    st.rerun()


if __name__ == "__main__":
    main()